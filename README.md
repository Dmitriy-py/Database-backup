# Домашнее задание к занятию «Резервное копирование баз данных»

## ` Дмитрий Климов `

### Задание 1. Резервное копирование

Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.

## Ответ:

### ` 1.1. Восстановление данных в полном объеме за предыдущий день: `

Подходящий вариант: Полное резервное копирование (Full Backup) в сочетании с инкрементным/дифференциальным резервным копированием.

Полное резервное копирование: Каждый день в определенное время (например, ночью, когда наименьшая нагрузка) делается полное резервное копирование всей базы данных. Это создает полную копию, с которой можно быстро восстановиться на состояние вчерашнего дня.

Инкрементное/Дифференциальное резервное копирование (опционально, но рекомендуется): Для ускорения восстановления и снижения нагрузки на систему в течение дня можно использовать инкрементное или дифференциальное резервное копирование.

Инкрементное: Копирует только те данные, которые изменились с момента последнего резервного копирования (полного или инкрементного). Восстановление требует полного бэкапа и всех последующих инкрементных.
Дифференциальное: Копирует данные, которые изменились с момента последнего полного резервного копирования. Восстановление требует полного бэкапа и последнего дифференциального.
Преимущества: Простота реализации полного резервного копирования. Быстрое восстановление до состояния вчерашнего дня.

Недостатки: Полные резервные копии занимают много места. Восстановление из инкрементных бэкапов может быть более долгим.

### ` 1.2. Восстановление данных за час до предполагаемой поломки: `

Подходящий вариант: Транзакционные логи (Transaction Log Backups) в сочетании с полным резервным копированием.

Транзакционные логи: Записывают все изменения, происходящие в базе данных в режиме реального времени или с небольшим интервалом (например, каждые 5-15 минут). Они позволяют восстановить базу данных до определенного момента времени.

Полное резервное копирование: Необходимо периодически выполнять полные резервные копии, чтобы избежать экспоненциального роста файлов логов транзакций и обеспечить возможность восстановления в случае повреждения лог-файлов.

Процесс восстановления: Восстанавливается последняя полная копия базы данных, а затем применяются все логи транзакций, записанные с момента этой полной копии до момента времени, к которому необходимо восстановить данные (час до поломки).

Преимущества: Восстановление до конкретного момента времени с высокой точностью. Минимальная потеря данных.

Недостатки: Более сложная настройка и управление. Требуется больше места для хранения логов транзакций. Восстановление может занять больше времени, чем восстановление только из полной копии.

### ` 1.3*. Моментальное переключение на работающую или починенную базу данных: `

Да, такой кейс возможен. Подходящие варианты: Кластеризация (Clustering) и Репликация (Replication).

Кластеризация: Несколько серверов базы данных работают вместе как один, обеспечивая высокую доступность. Если один сервер выходит из строя, другие автоматически берут на себя его нагрузку.

Репликация: Данные реплицируются (копируются) в режиме реального времени или почти реального времени на один или несколько резервных серверов. В случае сбоя основного сервера, один из резервных серверов может быть быстро активирован как новый основной сервер (failover). Репликация бывает нескольких типов:

Синхронная репликация: Транзакции записываются одновременно на основной и резервный серверы. Обеспечивает наименьшую потерю данных, но может влиять на производительность.
Асинхронная репликация: Транзакции сначала записываются на основной сервер, а затем передаются на резервный. Меньше влияет на производительность, но возможна небольшая потеря данных в случае сбоя основного сервера.
Преимущества: Минимальное время простоя. Высокая доступность. Автоматическое переключение в случае сбоя.

Недостатки: Наиболее сложная и дорогая в реализации. Требует значительных ресурсов. Необходим тщательный мониторинг и настройка.

Рекомендации для финансовой компании:

Использовать комбинацию подходов: Для достижения максимальной надежности и гибкости рекомендуется использовать комбинацию различных подходов к резервному копированию. Например, полное резервное копирование + транзакционные логи + репликация.
Регулярно тестировать резервные копии: Крайне важно регулярно тестировать восстановление из резервных копий, чтобы убедиться в их работоспособности и своевременно выявлять возможные проблемы.
Автоматизировать процессы: Максимально автоматизировать процессы резервного копирования и восстановления, чтобы минимизировать человеческий фактор и сократить время простоя.
Хранить резервные копии в разных местах: Хранить резервные копии как минимум в двух разных физических местах, чтобы защититься от различных катастроф (пожар, затопление и т.д.).
Шифровать резервные копии: Шифровать резервные копии, особенно если они хранятся в облаке или на внешних носителях, чтобы защитить конфиденциальные данные от несанкционированного доступа.
Выбрать правильную стратегию репликации: В зависимости от требований к допустимой потере данных и производительности следует выбрать синхронную или асинхронную репликацию.
Внедрить систему мониторинга: Постоянно мониторить состояние базы данных и процесса репликации для оперативного выявления и устранения проблем.
В заключение, выбор оптимальной стратегии резервного копирования зависит от конкретных требований и бюджета финансовой компании. Важно тщательно проанализировать все факторы и выбрать наиболее подходящий вариант.


### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Приведите ответ в свободной форме.

## Ответ:


### ` 2.1. Пример команд резервирования и восстановления: `

Резервное копирование (pg_dump):

Предположим, у нас есть база данных с именем mydatabase и мы хотим создать ее резервную копию в файле mydatabase.backup.

Полное резервное копирование в текстовом формате (SQL-скрипт):

```
bash

pg_dump -U myuser -W -F p -f mydatabase.sql mydatabase
```
-U myuser: Указывает имя пользователя для подключения к базе данных.
-W: Запрашивает пароль пользователя. (Рекомендуется избегать указывать пароль в командной строке).
-F p: Указывает формат вывода “plain” (текстовый SQL-скрипт).
-f mydatabase.sql: Указывает имя файла, в который будет записана резервная копия.
mydatabase: Указывает имя базы данных, которую нужно скопировать.

Полное резервное копирование в пользовательском формате (custom format) (рекомендуемый для восстановления):

```
bash

pg_dump -U myuser -W -F c -f mydatabase.backup mydatabase
```
-F c: Указывает формат вывода “custom” (сжатый, для использования с pg_restore).

Резервное копирование только структуры базы данных (без данных):

```
bash

pg_dump -U myuser -W -s -f mydatabase_schema.sql mydatabase
```

-s: Указывает, что нужно скопировать только схему (структуру) базы данных.

Восстановление (pg_restore):

Восстановление из текстового SQL-скрипта:

```
bash

psql -U myuser -W -d targetdatabase -f mydatabase.sql

```

-d targetdatabase: Указывает имя базы данных, в которую нужно восстановить данные. Если базы данных не существует, ее нужно создать вручную.

Восстановление из пользовательского формата (custom format):

```
bash

pg_restore -U myuser -W -d targetdatabase mydatabase.backup

```

Если база targetdatabase не существует, pg_restore может её создать (если в архиве есть соответствующая инструкция, которая генерируется pg_dump с опцией -Fc). В противном случае ее нужно создать вручную.

Важные замечания:

Права доступа: Убедитесь, что пользователь, используемый для резервного копирования и восстановления, имеет необходимые права доступа к базе данных.

Создание базы данных: При восстановлении из файла, содержащего только данные, сначала необходимо создать целевую базу данных (если она еще не существует).

Сжатие: Для больших баз данных рекомендуется использовать сжатие при резервном копировании.
Параллельное восстановление: pg_restore поддерживает параллельное восстановление (опция -j), что может значительно ускорить процесс.

Аргументы pg_dump и pg_restore: в зависимости от настроек вашей СУБД и требуемого результата, нужно правильно подбирать аргументы для этих команд. Например, аргумент --clean удалит существующие объекты базы данных перед их восстановлением, что может быть полезно для обновления базы данных из резервной копии.


### `2.1.* Автоматизация процесса резервного копирования: `

Да, процесс резервного копирования можно и нужно автоматизировать. Это критически важно для обеспечения надежности и своевременности резервного копирования. Вот несколько способов:

Cron (Linux/Unix):

Cron - это планировщик задач в Linux/Unix-подобных системах. Он позволяет запускать команды или скрипты автоматически в заданное время и с заданной периодичностью.

Пример:

```
bash

# crontab -e
0 2 * * * pg_dump -U myuser -W -F c -f /path/to/backups/mydatabase_$(date +\%Y\%m\%d).backup mydatabase > /dev/null 2>&1

```

Эта запись в crontab запускает pg_dump каждый день в 2:00 ночи. Результат сохраняется в файл с именем mydatabase_YYYYMMDD.backup в указанной директории. > /dev/null 2>&1 перенаправляет весь вывод (стандартный и ошибки) в никуда, чтобы не засорять почту пользователя. Использование % в crontab требует экранирования с помощью \.

Безопасность: Не храните пароль пользователя в crontab. Лучше использовать аутентификацию через .pgpass или настроить аутентификацию по сертификатам.
pg_cron (PostgreSQL extension):

pg_cron - это расширение PostgreSQL, которое позволяет планировать задачи непосредственно в базе данных.

Установите расширение:

```
sql

CREATE EXTENSION pg_cron;

```

Запланируйте задачу:

```
sql

SELECT cron.schedule('0 2 * * *', 'pg_dump -U myuser -W -F c -f /path/to/backups/mydatabase_$(date +%Y%m%d).backup mydatabase');

```

Эта команда планирует выполнение команды pg_dump аналогично примеру с crontab, но задача хранится в базе данных.


Преимущества: Управление задачами централизовано в базе данных.

Недостатки: Требует установки и настройки расширения.

Системы управления резервным копированием (Backup Management Systems):

Существуют специализированные системы управления резервным копированием, которые предоставляют расширенные возможности, такие как централизованное управление, мониторинг, отчетность и т.д.

Примеры: Bacula, Amanda, Veeam, Acronis.

Преимущества: Широкий набор функций, удобный интерфейс.

Недостатки: Могут быть платными, требуют сложной настройки.

Скрипты на Bash/Python и другие языки:

Можно написать скрипт на Bash, Python или другом языке программирования для автоматизации резервного копирования. Скрипт может выполнять резервное копирование, сжимать файлы, загружать их в облачное хранилище и отправлять уведомления об успехе/неудаче. Этот скрипт затем можно запустить через Cron.
Преимущества: Гибкость, возможность настройки под конкретные нужды.
Недостатки: Требует навыков программирования.
Рекомендации по автоматизации:

Автоматизация должна быть приоритетной: Резервное копирование должно быть автоматизировано в обязательном порядке.

Выбор инструмента: Выбор инструмента автоматизации зависит от вашего окружения, бюджета и требований к функциональности.

Мониторинг: Настройте мониторинг процесса резервного копирования, чтобы своевременно выявлять и устранять проблемы. Например, отправлять уведомления по электронной почте в случае ошибок.

Ротация резервных копий: Автоматизируйте ротацию резервных копий, чтобы не переполнить хранилище. Например, удалять старые резервные копии через определенный период времени.

Логирование: Включите подробное логирование процесса резервного копирования, чтобы облегчить отладку в случае проблем.

Тестирование: Регулярно тестируйте восстановление из резервных копий, чтобы убедиться в их работоспособности.

Безопасное хранение учетных данных: Никогда не храните пароли непосредственно в скриптах или файлах конфигурации. Используйте безопасные механизмы, такие как переменные окружения или файлы конфигурации с ограниченным доступом, или используйте аутентификацию по сертификатам.

Автоматизация резервного копирования – это важный шаг к обеспечению надежности и безопасности данных вашей базы данных PostgreSQL. Выберите метод, который лучше всего соответствует вашим потребностям, и убедитесь, что он правильно настроен и регулярно тестируется.


### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

Приведите ответ в свободной форме.

## Ответ:

### ` 3.1. Пример команды инкрементного резервного копирования MySQL `

MySQL не предоставляет встроенной команды для инкрементного резервного копирования на уровне файлов, как, например, у PostgreSQL с WAL-архивами. В MySQL инкрементное резервное копирование обычно реализуется с использованием бинарных логов (binary logs). Бинарные логи записывают все изменения данных, внесенные в базу данных.

Вот примеры команд и шагов для выполнения инкрементного резервного копирования с использованием бинарных логов:

1. Включение бинарного логирования:

Убедитесь, что бинарное логирование включено в конфигурационном файле MySQL (my.cnf или my.ini). Найдите секцию [mysqld] и добавьте или раскомментируйте следующие строки:

```
log_bin = mysql-bin  # имя префикса для файлов бинарных логов
binlog_format = ROW  # формат логирования (ROW - наиболее безопасный для восстановления)
expire_logs_days = 7 # удалять бинарные логи старше 7 дней
server_id   = 1      # Уникальный ID сервера (обязательно для репликации, но полезно и для простого логирования)

```

Перезапустите сервер MySQL, чтобы изменения вступили в силу.

2. Создание начального полного резервного копирования:

Выполните полное резервное копирование базы данных. Это будет отправной точкой для инкрементных резервных копий.

```
bash

mysqldump -u root -p --all-databases --master-data=2 > full_backup.sql

```

-u root: Имя пользователя MySQL.
-p: Запросит пароль.
--all-databases: Создать резервную копию всех баз данных.
--master-data=2: Добавит в резервную копию информацию о текущей позиции в бинарном логе (имя файла и позицию), что необходимо для последующего восстановления. Установка в 2 оборачивает эти данные в комментарии.
full_backup.sql: Имя файла для полного резервного копирования.

3. Копирование бинарных логов (инкрементное резервное копирование):

Регулярно копируйте файлы бинарных логов в безопасное место. Для этого можно использовать скрипт, который будет выполняться по расписанию (например, с помощью cron).

```

bash

#!/bin/bash
# Скрипт для копирования бинарных логов MySQL

BACKUP_DIR="/path/to/binlog/backup"
MYSQL_USER="root"
MYSQL_PASSWORD="your_password" # Не рекомендуется хранить пароль в скрипте! Лучше используйте mysql_config_editor.

# Получаем список всех бинарных логов
BINLOG_FILES=$(mysql -u $MYSQL_USER -p"$MYSQL_PASSWORD" -e "SHOW BINARY LOGS;" | awk '{print $1}' | tail -n +2)

# Создаем директорию для бэкапа, если ее нет
mkdir -p "$BACKUP_DIR"

# Копируем каждый бинарный лог
for log_file in $BINLOG_FILES; do
  cp /var/log/mysql/$log_file "$BACKUP_DIR/$log_file"
done

echo "Бинарные логи скопированы в $BACKUP_DIR"

```

Этот скрипт получает список всех бинарных логов с помощью SHOW BINARY LOGS и копирует их в указанную директорию.
Важно! Изменить значения BACKUP_DIR, MYSQL_USER и MYSQL_PASSWORD на соответствующие значения в системе.
Безопасность! Никогда не храните пароль в скрипте в открытом виде. Используйте mysql_config_editor или другие безопасные способы хранения учетных данных.

4. Восстановление:

Восстановите полное резервное копирование:

```

bash

mysql -u root -p < full_backup.sql

```

Применить бинарные логи: Определить, с какого бинарного лога и позиции нужно начать восстановление. Эта информация есть в полном бэкапе (в виде комментариев).

```
bash

mysqlbinlog --start-position="позиция из полного бэкапа" --stop-datetime="YYYY-MM-DD HH:MM:SS" /path/to/binlog/backup/mysql-bin.000001 | mysql -u root -p
mysqlbinlog --start-position="позиция из предыдущего лога" --stop-datetime="YYYY-MM-DD HH:MM:SS" /path/to/binlog/backup/mysql-bin.000002 | mysql -u root -p
# ... и так далее для каждого бинарного лога

```

--start-position: Начальная позиция в бинарном логе, с которой нужно начать применять изменения.
--stop-datetime: Время, до которого нужно применить изменения. Указать время перед предполагаемой поломкой.
/path/to/binlog/backup/mysql-bin.000001: Путь к файлу бинарного лога.
Применять бинарные логи последовательно, начиная с первого лога, содержащего изменения после полного резервного копирования.

Важно!

Регулярно проверяйте целостность резервных копий и бинарных логов.
Тестируйте процесс восстановления, чтобы убедиться, что он работает правильно.
Храните резервные копии и бинарные логи в безопасном месте, отдельно от сервера базы данных.
Рассмотрите возможность использования инструментов для автоматизации резервного копирования и восстановления, таких как Percona XtraBackup (хотя он больше ориентирован на полные бэкапы, он также хорошо управляет бинарными логами).
3.1. Преимущества репликации по сравнению с обычным резервным копированием*

Репликация и резервное копирование - это разные, но взаимодополняющие стратегии защиты данных. Репликация имеет ряд преимуществ по сравнению с обычным резервным копированием, особенно в определенных сценариях:

Высокая доступность (High Availability - HA): Основное преимущество репликации – это обеспечение высокой доступности. В случае сбоя основного сервера (мастера), один из реплик (ведомый сервер) может быть быстро переключен в режим мастера (failover), минимизируя время простоя. При обычном резервном копировании требуется время на восстановление данных на другом сервере, что приводит к значительно большему простою.

Быстрое восстановление: В случае повреждения данных на основном сервере, можно быстро восстановить данные из реплики. Этот процесс обычно занимает меньше времени, чем восстановление из резервной копии, особенно если резервная копия большая.

Распределение нагрузки (Read Scaling): Реплики можно использовать для обработки запросов на чтение, снижая нагрузку на основной сервер. Это особенно полезно для приложений с большим количеством операций чтения. Обычное резервное копирование не предоставляет такой возможности.

Географическое распределение: Реплики можно размещать в разных географических регионах, чтобы обеспечить защиту от региональных сбоев (например, стихийных бедствий). В случае сбоя в одном регионе, реплика в другом регионе может взять на себя роль основного сервера. Обычное резервное копирование может быть недостаточно быстрым для таких сценариев.

Тестирование и разработка: Реплики можно использовать для тестирования новых версий программного обеспечения или изменений в схеме базы данных без риска повредить основной сервер. Обычное резервное копирование также можно использовать для этой цели, но репликация обеспечивает более актуальные данные.

Аналитика: Реплики можно использовать для запуска аналитических запросов, которые могут быть ресурсоемкими и замедлять работу основного сервера.

В каких случаях репликация наиболее полезна:

Критически важные приложения: Для приложений, где простой недопустим или должен быть минимальным (например, финансовые системы, системы онлайн-торговли).

Приложения с высокой нагрузкой на чтение: Для приложений, где необходимо масштабировать производительность для обработки большого количества запросов на чтение.

Приложения, требующие географической отказоустойчивости: Для приложений, которые должны быть доступны даже в случае региональных сбоев.

Недостатки репликации:

Сложность настройки и управления: Репликация требует более сложной настройки и управления, чем обычное резервное копирование.

Стоимость: Требуется дополнительное оборудование и ресурсы для работы реплик.

Задержка репликации (Replication Lag): Данные на реплике могут быть немного устаревшими по сравнению с основным сервером (особенно при асинхронной репликации). Это может быть проблемой для приложений, требующих немедленной консистентности данных.

Не заменяет резервное копирование! Репликация не заменяет резервное копирование. Она обеспечивает высокую доступность и быстрое восстановление, но не защищает от логических ошибок, таких как случайное удаление данных или повреждение данных из-за ошибок в приложении. Резервное копирование необходимо для восстановления данных в таких случаях.

В заключение:

Репликация и резервное копирование - это важные компоненты стратегии защиты данных. Репликация обеспечивает высокую доступность и быстрое восстановление, в то время как резервное копирование обеспечивает защиту от широкого спектра угроз, включая логические ошибки и катастрофические сбои. Для обеспечения максимальной защиты данных рекомендуется использовать оба подхода.




