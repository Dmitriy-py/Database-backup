# Домашнее задание к занятию «Резервное копирование баз данных»

## ` Дмитрий Климов `

### Задание 1. Резервное копирование

Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Приведите ответ в свободной форме.

## Ответ:

### ` 1.1. Восстановление данных в полном объеме за предыдущий день: `

Подходящий вариант: Полное резервное копирование (Full Backup) в сочетании с инкрементным/дифференциальным резервным копированием.

Полное резервное копирование: Каждый день в определенное время (например, ночью, когда наименьшая нагрузка) делается полное резервное копирование всей базы данных. Это создает полную копию, с которой можно быстро восстановиться на состояние вчерашнего дня.

Инкрементное/Дифференциальное резервное копирование (опционально, но рекомендуется): Для ускорения восстановления и снижения нагрузки на систему в течение дня можно использовать инкрементное или дифференциальное резервное копирование.

Инкрементное: Копирует только те данные, которые изменились с момента последнего резервного копирования (полного или инкрементного). Восстановление требует полного бэкапа и всех последующих инкрементных.
Дифференциальное: Копирует данные, которые изменились с момента последнего полного резервного копирования. Восстановление требует полного бэкапа и последнего дифференциального.
Преимущества: Простота реализации полного резервного копирования. Быстрое восстановление до состояния вчерашнего дня.

Недостатки: Полные резервные копии занимают много места. Восстановление из инкрементных бэкапов может быть более долгим.

### ` 1.2. Восстановление данных за час до предполагаемой поломки: `

Подходящий вариант: Транзакционные логи (Transaction Log Backups) в сочетании с полным резервным копированием.

Транзакционные логи: Записывают все изменения, происходящие в базе данных в режиме реального времени или с небольшим интервалом (например, каждые 5-15 минут). Они позволяют восстановить базу данных до определенного момента времени.

Полное резервное копирование: Необходимо периодически выполнять полные резервные копии, чтобы избежать экспоненциального роста файлов логов транзакций и обеспечить возможность восстановления в случае повреждения лог-файлов.

Процесс восстановления: Восстанавливается последняя полная копия базы данных, а затем применяются все логи транзакций, записанные с момента этой полной копии до момента времени, к которому необходимо восстановить данные (час до поломки).

Преимущества: Восстановление до конкретного момента времени с высокой точностью. Минимальная потеря данных.

Недостатки: Более сложная настройка и управление. Требуется больше места для хранения логов транзакций. Восстановление может занять больше времени, чем восстановление только из полной копии.

### ` 1.3*. Моментальное переключение на работающую или починенную базу данных: `

Да, такой кейс возможен. Подходящие варианты: Кластеризация (Clustering) и Репликация (Replication).

Кластеризация: Несколько серверов базы данных работают вместе как один, обеспечивая высокую доступность. Если один сервер выходит из строя, другие автоматически берут на себя его нагрузку.

Репликация: Данные реплицируются (копируются) в режиме реального времени или почти реального времени на один или несколько резервных серверов. В случае сбоя основного сервера, один из резервных серверов может быть быстро активирован как новый основной сервер (failover). Репликация бывает нескольких типов:

Синхронная репликация: Транзакции записываются одновременно на основной и резервный серверы. Обеспечивает наименьшую потерю данных, но может влиять на производительность.
Асинхронная репликация: Транзакции сначала записываются на основной сервер, а затем передаются на резервный. Меньше влияет на производительность, но возможна небольшая потеря данных в случае сбоя основного сервера.
Преимущества: Минимальное время простоя. Высокая доступность. Автоматическое переключение в случае сбоя.

Недостатки: Наиболее сложная и дорогая в реализации. Требует значительных ресурсов. Необходим тщательный мониторинг и настройка.

Рекомендации для финансовой компании:

Использовать комбинацию подходов: Для достижения максимальной надежности и гибкости рекомендуется использовать комбинацию различных подходов к резервному копированию. Например, полное резервное копирование + транзакционные логи + репликация.
Регулярно тестировать резервные копии: Крайне важно регулярно тестировать восстановление из резервных копий, чтобы убедиться в их работоспособности и своевременно выявлять возможные проблемы.
Автоматизировать процессы: Максимально автоматизировать процессы резервного копирования и восстановления, чтобы минимизировать человеческий фактор и сократить время простоя.
Хранить резервные копии в разных местах: Хранить резервные копии как минимум в двух разных физических местах, чтобы защититься от различных катастроф (пожар, затопление и т.д.).
Шифровать резервные копии: Шифровать резервные копии, особенно если они хранятся в облаке или на внешних носителях, чтобы защитить конфиденциальные данные от несанкционированного доступа.
Выбрать правильную стратегию репликации: В зависимости от требований к допустимой потере данных и производительности следует выбрать синхронную или асинхронную репликацию.
Внедрить систему мониторинга: Постоянно мониторить состояние базы данных и процесса репликации для оперативного выявления и устранения проблем.
В заключение, выбор оптимальной стратегии резервного копирования зависит от конкретных требований и бюджета финансовой компании. Важно тщательно проанализировать все факторы и выбрать наиболее подходящий вариант.


### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Приведите ответ в свободной форме.

## Ответ:


### ` 2.1. Пример команд резервирования и восстановления: `

Резервное копирование (pg_dump):

Предположим, у нас есть база данных с именем mydatabase и мы хотим создать ее резервную копию в файле mydatabase.backup.

Полное резервное копирование в текстовом формате (SQL-скрипт):

```
bash

pg_dump -U myuser -W -F p -f mydatabase.sql mydatabase
```
-U myuser: Указывает имя пользователя для подключения к базе данных.
-W: Запрашивает пароль пользователя. (Рекомендуется избегать указывать пароль в командной строке).
-F p: Указывает формат вывода “plain” (текстовый SQL-скрипт).
-f mydatabase.sql: Указывает имя файла, в который будет записана резервная копия.
mydatabase: Указывает имя базы данных, которую нужно скопировать.

Полное резервное копирование в пользовательском формате (custom format) (рекомендуемый для восстановления):

```
bash

pg_dump -U myuser -W -F c -f mydatabase.backup mydatabase
```
-F c: Указывает формат вывода “custom” (сжатый, для использования с pg_restore).

Резервное копирование только структуры базы данных (без данных):

```
bash

pg_dump -U myuser -W -s -f mydatabase_schema.sql mydatabase
```

-s: Указывает, что нужно скопировать только схему (структуру) базы данных.

Восстановление (pg_restore):

Восстановление из текстового SQL-скрипта:

```
bash

psql -U myuser -W -d targetdatabase -f mydatabase.sql

```

-d targetdatabase: Указывает имя базы данных, в которую нужно восстановить данные. Если базы данных не существует, ее нужно создать вручную.

Восстановление из пользовательского формата (custom format):

```
bash

pg_restore -U myuser -W -d targetdatabase mydatabase.backup

```

Если база targetdatabase не существует, pg_restore может её создать (если в архиве есть соответствующая инструкция, которая генерируется pg_dump с опцией -Fc). В противном случае ее нужно создать вручную.

Важные замечания:

Права доступа: Убедитесь, что пользователь, используемый для резервного копирования и восстановления, имеет необходимые права доступа к базе данных.
Создание базы данных: При восстановлении из файла, содержащего только данные, сначала необходимо создать целевую базу данных (если она еще не существует).
Сжатие: Для больших баз данных рекомендуется использовать сжатие при резервном копировании.
Параллельное восстановление: pg_restore поддерживает параллельное восстановление (опция -j), что может значительно ускорить процесс.
Аргументы pg_dump и pg_restore: в зависимости от настроек вашей СУБД и требуемого результата, нужно правильно подбирать аргументы для этих команд. Например, аргумент --clean удалит существующие объекты базы данных перед их восстановлением, что может быть полезно для обновления базы данных из резервной копии.


### `2.1.* Автоматизация процесса резервного копирования: `

Да, процесс резервного копирования можно и нужно автоматизировать. Это критически важно для обеспечения надежности и своевременности резервного копирования. Вот несколько способов:

Cron (Linux/Unix):

Cron - это планировщик задач в Linux/Unix-подобных системах. Он позволяет запускать команды или скрипты автоматически в заданное время и с заданной периодичностью.

Пример:

```
bash

# crontab -e
0 2 * * * pg_dump -U myuser -W -F c -f /path/to/backups/mydatabase_$(date +\%Y\%m\%d).backup mydatabase > /dev/null 2>&1

```

Эта запись в crontab запускает pg_dump каждый день в 2:00 ночи. Результат сохраняется в файл с именем mydatabase_YYYYMMDD.backup в указанной директории. > /dev/null 2>&1 перенаправляет весь вывод (стандартный и ошибки) в никуда, чтобы не засорять почту пользователя. Использование % в crontab требует экранирования с помощью \.

Безопасность: Не храните пароль пользователя в crontab. Лучше использовать аутентификацию через .pgpass или настроить аутентификацию по сертификатам.
pg_cron (PostgreSQL extension):

pg_cron - это расширение PostgreSQL, которое позволяет планировать задачи непосредственно в базе данных.

Установите расширение:

```
sql

CREATE EXTENSION pg_cron;

```

Запланируйте задачу:

```
sql

SELECT cron.schedule('0 2 * * *', 'pg_dump -U myuser -W -F c -f /path/to/backups/mydatabase_$(date +%Y%m%d).backup mydatabase');

```

Эта команда планирует выполнение команды pg_dump аналогично примеру с crontab, но задача хранится в базе данных.


Преимущества: Управление задачами централизовано в базе данных.

Недостатки: Требует установки и настройки расширения.

Системы управления резервным копированием (Backup Management Systems):

Существуют специализированные системы управления резервным копированием, которые предоставляют расширенные возможности, такие как централизованное управление, мониторинг, отчетность и т.д.
Примеры: Bacula, Amanda, Veeam, Acronis.
Преимущества: Широкий набор функций, удобный интерфейс.
Недостатки: Могут быть платными, требуют сложной настройки.
Скрипты на Bash/Python и другие языки:

Можно написать скрипт на Bash, Python или другом языке программирования для автоматизации резервного копирования. Скрипт может выполнять резервное копирование, сжимать файлы, загружать их в облачное хранилище и отправлять уведомления об успехе/неудаче. Этот скрипт затем можно запустить через Cron.
Преимущества: Гибкость, возможность настройки под конкретные нужды.
Недостатки: Требует навыков программирования.
Рекомендации по автоматизации:

Автоматизация должна быть приоритетной: Резервное копирование должно быть автоматизировано в обязательном порядке.

Выбор инструмента: Выбор инструмента автоматизации зависит от вашего окружения, бюджета и требований к функциональности.

Мониторинг: Настройте мониторинг процесса резервного копирования, чтобы своевременно выявлять и устранять проблемы. Например, отправлять уведомления по электронной почте в случае ошибок.

Ротация резервных копий: Автоматизируйте ротацию резервных копий, чтобы не переполнить хранилище. Например, удалять старые резервные копии через определенный период времени.

Логирование: Включите подробное логирование процесса резервного копирования, чтобы облегчить отладку в случае проблем.

Тестирование: Регулярно тестируйте восстановление из резервных копий, чтобы убедиться в их работоспособности.

Безопасное хранение учетных данных: Никогда не храните пароли непосредственно в скриптах или файлах конфигурации. Используйте безопасные механизмы, такие как переменные окружения или файлы конфигурации с ограниченным доступом, или используйте аутентификацию по сертификатам.

Автоматизация резервного копирования – это важный шаг к обеспечению надежности и безопасности данных вашей базы данных PostgreSQL. Выберите метод, который лучше всего соответствует вашим потребностям, и убедитесь, что он правильно настроен и регулярно тестируется.







